<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Doação via Pix - Juliano Lima</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    input, button {
      font-size: 16px;
      padding: 10px;
      margin: 10px;
    }
    #qr {
      margin-top: 20px;
    }
    #emv {
      white-space: pre-wrap;
      word-break: break-word;
      border: 1px solid #ccc;
      padding: 10px;
      font-family: monospace;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <h1>Doação via Pix</h1>
  <p>Destinatário: <strong>Juliano Lima</strong></p>

  <input type="number" id="valor" placeholder="Digite o valor (opcional)" step="0.01" min="0">
  <br>
  <button onclick="gerarPix()">Gerar QR Code e EMV</button>

  <div id="qr"></div>

  <h3>Pix Copia e Cola (EMV)</h3>
  <pre id="emv"></pre>
  <button onclick="copiarEmv()">Copiar EMV</button>

  <script>
    function format(id, content) {
      return id + content.length.toString().padStart(2, '0') + content;
    }

    function crc16(str) {
      let crc = 0xFFFF;
      for (let i = 0; i < str.length; i++) {
        crc ^= str.charCodeAt(i) << 8;
        for (let j = 0; j < 8; j++) {
          if ((crc & 0x8000) !== 0) {
            crc = (crc << 1) ^ 0x1021;
          } else {
            crc <<= 1;
          }
          crc &= 0xFFFF;
        }
      }
      return crc.toString(16).toUpperCase().padStart(4, '0');
    }

    function gerarPix() {
      const valor = parseFloat(document.getElementById("valor").value || "").toFixed(2);
      const chave = "julianomarcelo.lima@gmail.com";
      const nome = "Juliano Lima";
      const cidade = "RIO DE JANEIRO";
      const txid = "DOACAO001";

      const gui = format("00", "01");
      const chavePix = format("01", chave);
      const merchantAccount = format("26", format("00", "BR.GOV.BCB.PIX") + chavePix);
      const mcc = format("52", "0000");
      const currency = format("53", "986");
      const amount = valor > 0 ? format("54", valor) : "";
      const country = format("58", "BR");
      const receiver = format("59", nome);
      const city = format("60", cidade);
      const txidField = format("62", format("05", txid));

      const payloadSemCRC = gui + merchantAccount + mcc + currency + amount + country + receiver + city + txidField + "6304";
      const crc = crc16(payloadSemCRC);
      const payloadCompleto = payloadSemCRC + crc;

      document.getElementById("emv").textContent = payloadCompleto;

      const qrDiv = document.getElementById("qr");
      qrDiv.innerHTML = "";
      QRCode.toCanvas(payloadCompleto, { width: 256 }, function (err, canvas) {
        if (err) console.error(err);
        qrDiv.appendChild(canvas);
      });
    }

    function copiarEmv() {
      const emvText = document.getElementById("emv").textContent;
      navigator.clipboard.writeText(emvText).then(() => {
        alert("EMV copiado para a área de transferência!");
      });
    }
  </script>

</body>
</html>
